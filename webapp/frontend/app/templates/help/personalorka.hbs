<p></p>
<div class="well well-lg text-center v-center">
    <div class="row">
        <h2 id = 'id_title_help_experiments'>Create Your Personal Orka Server</h2>
        <p></p>
        <p>Information on creating a personal server for providing the Orka services</p>
    </div>
</div>
<div class="col col-sm-12">
<h1>Orka service</h1>

<p>Orka service is deployed and accessed by a personal Orka server. Every ~okeanos user can build a personal Orka server by following the instructions <a href="#/help/personalorka/orkaserverinfo">here</a>.</p>

<h2>Create ~okeanos image for personal Orka server (for administrators)</h2>

<p>The python script deploy_orka_server.py can be used either for creating an ~okeanos Orka server image
or starting an Orka server created by such an image. Before using the script as image creator, the following packages must be installed
(tested in Debian 8 ~okeanos bare image):</p>

<pre><code>sudo apt-get update
sudo apt-get install -y git
sudo apt-get install -y python python-dev gcc 
wget https://bootstrap.pypa.io/get-pip.py;
sudo python get-pip.py
sudo pip install kamaki
sudo pip install ansible
</code></pre>

<p><strong>Important</strong>: a public ssh key must exist locally as ~/.ssh/id_rsa.pub. If not, the python script will exit.</p>

<p>Clone the e-Science project and run the python script:</p>

<pre><code>git clone &lt;escience git repo&gt;
cd &lt;project_root&gt;/deploy/
python deploy_orka_server.py create --name=\{{orka_image}} --flavor_id=\{{~okeanos_flavor_number}} --project_id=\{{~okeanos_project_id}} --image_id=\{{~okeanos_debian_image_id}} --git_repo=\{{project_repo_in_github}} --git_repo_version=\{{version_or_branch_of_repo}} --token=\{{~okeanos_token}}
</code></pre>

<p>This will create a virtual machine in ~okeanos and install everything that is needed for the orka server to function with Debian 8.2, but without configuring sensitive parameters and passwords.
After VM becomes active, the admin/image-creator can ssh to the virtual machine and after removing authorized_keys files:</p>

<pre><code>rm /root/.ssh/authorized_keys
rm /home/orka_admin/.ssh/authorized_keys
</code></pre>

<p>run:</p>

<pre><code>snf-mkimage --public --print-syspreps -f -u \{{name_of_Orka_server_image}} -t \{{~okeanos_token}} -a \{{auth_url}} -r \{{name_of_Orka_server_image}} /
</code></pre>

<p>After snf-image-creator finishes, the image will be ready for building Orka servers.
More information about the software that is installed for the creation of the image can be found in the following Ansible playbooks:</p>

<pre><code>deploy/setup_orka_admin.yml
deploy/roles/webserver/tasks/main.yml
</code></pre>

<h3>Example of creating an ~okeanos image for personal Orka server</h3>

<p>Assuming the administrator's Linux working environment is ~okeanos Debian Base 8.2 without a pair of SSH keys. The following steps can be executed as root or as a user with sudo privileges:</p>

<pre><code>sudo apt-get update
sudo apt-get install -y git
sudo apt-get install -y python python-dev gcc 
wget https://bootstrap.pypa.io/get-pip.py;
sudo python get-pip.py
sudo pip install kamaki
sudo pip install ansible
ssh-keygen -t rsa (rest of the arguments can be left to default)
</code></pre>

<p>Clone the e-Science project and run the python script:</p>

<pre><code>git clone https://github.com/grnet/e-science.git
cd e-science/deploy/
python deploy_orka_server.py create --name=orka_image_vm --flavor_id=39 --project_id=11aaaaa1-11dd-11ae-a11e-a1a211111111 --image_id=a1111aa1-1aa1-1aa1-aa11-aaaa111a11aa --git_repo=https://github.com/grnet/e-science.git --git_repo_version=master --token=AAa1aAaAAA1a1A1ABA1AA1aAAaa1aaaaaaaa11_111a
</code></pre>

<p>This will create a virtual machine in ~okeanos and install everything that is needed for the server to provide the Orka services.
After VM becomes active, the administrator must do the following:</p>

<pre><code>ssh root@\{{virtual_machine_public_IPv4}}
rm /root/.ssh/authorized_keys
rm /home/orka_admin/.ssh/authorized_keys
snf-mkimage --public --print-syspreps -f -u Orka_on_Debian_8_image -t AAa1aAaAAA1a1A1ABA1AA1aAAaa1aaaaaaaa11_111a -a https://accounts.okeanos.grnet.gr/identity/v2.0 -r Orka_on_Debian_8_image /
</code></pre>

<p>After snf-image-creator is finished, the new image can be used for the creation of Orka servers.</p>

<a name="/help/personalorka/orkaserverinfo"><h2>Create a personal Orka server in ~okeanos (for users)</h2></a>

<p>Users should read the following section, regarding Orka server requirements, before starting the creation of their personal Orka server.</p>

<h3>Orka server Hardware Requirements</h3>

<p>Minimum Requirements: 1 CPU, 1 GB RAM and 5 GB for disk size.</p>

<p>Recommended: 2 CPUs, 2 GB RAM and 10 GB for disk size.</p>

<p>Number of CPUs dictate the amount of long running tasks the Orka server executes at the same time. With 1 CPU for example, a user will not be able to build two different Hadoop clusters at the same time. </p>

<h3>Create and start personal Orka server</h3>

<p>User creates a virtual machine in ~okeanos based on "Orka Server-on-Debian 8" image, with a public IPv4 attached, and then types in console:</p>

<pre><code>ssh root@\{{virtual_machine_public_IPv4}}
passwd orka_admin
su - orka_admin
cd projects/e-science/deploy
</code></pre>

<p>The python script that starts the Orka server reads critical information from a user-created yaml file.
In deploy directory there is a sample file (deploy_sample_file.yml) which can be used as a template for the user-created deploy yaml file.
A user can copy the template file (inside projects/e-science/deploy):</p>

<pre><code>cp deploy_sample_file.yml &lt;user_created_yaml_file&gt;.yml
nano &lt;user_created_yaml_file&gt;.yml
</code></pre>

<p>and then edit the file:</p>

<pre><code># Password of system user orka_admin
orka_admin_password: &lt;the Linux password of orka_admin user. It is the password the user gave just after the first ssh before, when ran passwd orka_admin&gt;
# Django admin password
django_admin_password: &lt;A password at least 8 characters long for administrator login in Orka server&gt;
# Password of postgresql user
postgresql_password: &lt;A password at least 8 characters long for postgresql database&gt;
# The okeanos uuid of the user who will login in the orka gui
okeanos_user_uuid: &lt;~okeanos_user_uuid. Below follows info on how to find the uuid&gt;
</code></pre>

<p>Users can find their unique ~okeanos_user_uuid from ~okeanos <a href="https://accounts.okeanos.grnet.gr/ui/api_access">webpage</a>. It is under <code>username</code> in Other clients section.</p>

<p>Alternatively, by running:</p>

<pre><code>kamaki user info
</code></pre>

<p>in an environment that kamaki is <a href="https://www.synnefo.org/docs/kamaki/latest/installation.html">set up</a>.</p>

<p>Finally, after done editing the user-created yml file, run the deploy script:</p>

<pre><code>python deploy_orka_server.py start &lt;path_to_user_created_yaml_file&gt;
</code></pre>

<p>When python script finishes successfully, user can open in a browser the public IP of Orka server and start using the Orka services.</p>

<h3><a name="/help/personalorka/restartorkaserver">Example of restarting a personal Orka server</a></h3>

<p>After starting an Orka server, the deploy_orka_server.py script can be used for restarting the server, in case of an error or after
an update. User must access the server:</p>

<pre><code>ssh root@\{{orka_server_ip}}
su - orka_admin
cd projects/e-science/deploy
</code></pre>

<p>and run the python script again with the 'restart' argument and the deploy file used for starting the server.</p>

<p><strong>In case of deletion of the deploy file used in starting the orka server</strong>, user must create it again but now the only mandatory entry in the file
is the <code>orka_admin_password</code>. So, a user creates the file:</p>

<pre><code>nano examplefile.yml
</code></pre>

<p>and adds only the following entry:</p>

<pre><code># Password of system user orka_admin
orka_admin_password: &lt;orka_admin linux password e.g. orkaadmintestpassword&gt;
</code></pre>

<p>If the user has kept his deploy file used in starting the server, the same file can be used again for restarting or updating the server.
In any case, Orka server will be restarted with the following command:</p>

<pre><code>python deploy_orka_server.py restart examplefile.yml
</code></pre>

<h3>Example of updating a personal Orka server</h3>

<p>Users can update their personal Orka servers, if there are updates in the main e-Science github repo, by running the python script
deploy_orka_server.py with the 'update' argument and the deploy file used for starting the server. If the deploy file was deleted,
the user must create it again, as shown in <a href="#/help/personalorka/restartorkaserver">restarting the server section</a>.</p>

<p>So, for updating the server, the following steps are required:</p>

<pre><code>ssh root@\{{orka_server_ip}}
su - orka_admin
cd projects/e-science/deploy
</code></pre>

<p>and run the script:</p>

<pre><code>python deploy_orka_server.py update examplefile.yml
</code></pre>

<p>after the update is done, server should be restarted with:</p>

<pre><code>python deploy_orka_server.py restart examplefile.yml
</code></pre>

<p>The default github repo that deploy_orka_server.py will look for updates is https://github.com/grnet/e-science.git at the master branch.
The github repo and branch/version is set in e-science/deploy/group_vars/webserver.yml file and can be changed.</p>

</div>

